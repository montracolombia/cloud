<script>
    const backendUrl = 'https://fastapi-backend-201226788937.us-central1.run.app';

    async function searchImages(event) {
        event.preventDefault();
        const sku = document.getElementById('sku').value;
        const errorMessage = document.getElementById('error-message');
        const results = document.getElementById('results');
        errorMessage.textContent = ''; // Limpiar mensaje de error
        results.innerHTML = ''; // Limpiar resultados anteriores

        try {
            console.log(`Sending search request to ${backendUrl}/search/${sku}`);
            const response = await fetch(`${backendUrl}/search/${sku}`);
            const data = await response.json();

            if (response.ok) {
                if (data.images.length > 0) {
                    data.images.forEach(imageUrl => {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = 'Imagen';
                        img.style.width = '200px';
                        img.style.cursor = 'pointer';
                        img.onclick = () => downloadImage(imageUrl); // Click para descargar
                        results.appendChild(img);
                    });
                } else {
                    results.innerHTML = '<p>No se encontraron imágenes.</p>';
                }
            } else {
                errorMessage.textContent = 'Error al buscar imágenes: ' + data.detail;
            }
        } catch (error) {
            console.error('Error during image search:', error);
            errorMessage.textContent = 'Error de conexión: ' + error.message;
        }
    }

    async function downloadImage(imageUrl) {
        const imageName = imageUrl.split('/').pop(); // Extraer nombre del archivo
        try {
            const response = await fetch(`${backendUrl}/download/${imageName}`);
            const data = await response.json();

            if (response.ok) {
                window.open(data.download_url, '_blank'); // Abrir la URL firmada en una nueva pestaña
            } else {
                alert('Error al generar el link de descarga: ' + data.detail);
            }
        } catch (error) {
            alert('Error de conexión: ' + error.message);
        }
    }
</script>
